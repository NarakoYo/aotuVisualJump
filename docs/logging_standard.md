# 日志记录规范化指南

## 1. 概述
本指南旨在规范项目中的日志记录实践，确保所有日志信息的一致性、可读性和有效性，特别是针对日志严重程度级别的正确使用。

## 2. 日志管理器介绍
项目使用 `LogManager` 类进行日志管理，这是一个单例模式的日志工具，支持异步写入、日志滚动和级别过滤功能。

## 3. 日志严重程度级别规范

### 3.1 级别定义
`LogManager` 类定义了以下日志严重程度级别（按严重程度递增排序）：

| 级别 | 描述 | 标识 | 使用场景 |
|------|------|------|----------|
| **Info** | 信息性消息 | `INFO` | 记录正常的程序运行状态、用户操作、系统初始化等常规信息 |
| **Warning** | 警告消息 | `WARNING` | 记录可能导致问题但不影响程序继续运行的异常情况 |
| **Error** | 错误消息 | `ERROR` | 记录已发生的错误，但程序仍能继续运行的情况 |
| **Fatal** | 致命错误 | `FATAL` | 记录导致程序无法继续运行的严重错误 |

### 3.2 级别使用规范

#### 3.2.1 Info 级别
- **使用时机**：记录程序正常运行过程中的关键节点
- **内容要求**：简洁明了，包含必要的上下文信息
- **示例场景**：
  - 程序启动和关闭
  - 用户登录/退出
  - 功能模块初始化完成
  - 定时任务开始/结束

#### 3.2.2 Warning 级别
- **使用时机**：记录可能需要关注但不影响当前功能的异常情况
- **内容要求**：说明潜在问题和可能的影响
- **示例场景**：
  - 配置项缺失但使用默认值
  - 资源获取超时但有重试机制
  - 参数格式不正确但已自动修正

#### 3.2.3 Error 级别
- **使用时机**：记录已发生的错误，但程序仍能继续运行
- **内容要求**：包含错误描述、异常详情和影响范围
- **示例场景**：
  - 单个功能执行失败
  - 外部服务调用失败
  - 文件读写错误

#### 3.2.4 Fatal 级别
- **使用时机**：记录导致程序无法继续运行的严重错误
- **内容要求**：详细的错误信息、堆栈跟踪和可能的原因分析
- **示例场景**：
  - 核心服务初始化失败
  - 数据库连接完全中断
  - 内存溢出或严重资源耗尽

## 4. 日志格式规范

### 4.1 日志条目格式
每个日志条目应遵循以下格式：
```
[时间戳-时区-日志级别-日志摘要]
    详细信息（如有多行）
```

### 4.2 时间戳格式
- 格式：`yyyy-MM-dd HH:mm:ss.fff`
- 示例：`2025-08-22 14:30:45.123`

### 4.3 日志内容规范
1. **简洁明了**：使用清晰、简短的语言描述事件
2. **包含关键信息**：记录与事件相关的关键参数、状态值等
3. **保持一致**：同类事件使用统一的描述方式
4. **避免冗余**：不记录重复或无关的信息
5. **敏感信息处理**：禁止在日志中记录密码、密钥等敏感信息

## 5. 日志记录最佳实践

### 5.1 通用实践
- **记录足够上下文**：确保日志能够帮助定位和诊断问题
- **日志级别适当**：根据事件的严重程度选择合适的日志级别
- **结构化记录**：使用一致的格式和关键字
- **定期清理**：配置合理的日志保留策略

### 5.2 异常处理中的日志记录
- **捕获异常时记录**：在捕获异常的位置记录错误日志
- **包含异常详情**：记录异常类型、消息和堆栈跟踪
- **区分异常严重程度**：根据异常对程序的影响选择合适的日志级别

### 5.3 性能考虑
- **避免过度记录**：特别是在高频调用的代码路径中
- **优先使用异步日志**：对性能敏感的场景使用 `WriteLogAsync` 方法
- **合理设置最低日志级别**：通过 `MinLogLevel` 属性过滤不必要的日志

## 6. 日志配置说明

### 6.1 配置项
日志管理器支持通过 `app.config` 文件配置以下参数：
- `Log.MaxFileSizeKB`：最大文件大小（KB）
- `Log.MaxFilesPerDay`：每天最多文件数
- `Log.MinLevel`：最小日志级别
- `Log.FileNameFormat`：日志文件名格式

### 6.2 默认配置
- 最大文件大小：1024 KB（1MB）
- 每天最多文件数：10个
- 默认日志级别：Info
- 默认文件名格式：yyyy-MM-dd-HH
- 默认日志目录：应用程序基目录下的logs文件夹

## 7. 日志管理API使用示例

### 7.1 获取日志管理器实例
```csharp
var logManager = LogManager.Instance;
```

### 7.2 写入不同级别的日志
```csharp
// 写入信息日志
logManager.WriteLog(LogManager.LogLevel.Info, "用户[张三]成功登录系统");

// 写入警告日志
logManager.WriteLog(LogManager.LogLevel.Warning, "配置文件缺失[cacheSize]项，使用默认值[1024]");

// 写入错误日志
logManager.WriteLog(LogManager.LogLevel.Error, $"文件读取失败: {ex.Message}\n{ex.StackTrace}");

// 写入致命错误日志
logManager.WriteLog(LogManager.LogLevel.Fatal, $"数据库连接失败，程序无法继续运行: {ex.Message}\n{ex.StackTrace}");
```

### 7.3 异步写入日志
```csharp
await logManager.WriteLogAsync(LogManager.LogLevel.Info, "异步记录批处理任务完成");
```

### 7.4 自定义日志配置
```csharp
// 设置最小日志级别为Warning
logManager.MinLogLevel = LogManager.LogLevel.Warning;

// 设置最大文件大小为5MB
logManager.MaxFileSizeKB = 5 * 1024;

// 清理7天前的日志
logManager.CleanupOldLogs(7);
```

## 8. 日志分析与排查指南

### 8.1 查找特定事件
1. 确定相关的时间范围
2. 根据事件类型选择可能的日志级别
3. 使用关键字搜索相关日志条目

### 8.2 常见问题排查
- **程序崩溃**：检查Fatal级别日志
- **功能异常**：检查Error级别日志
- **性能问题**：分析Info级别日志中的关键操作耗时
- **间歇性问题**：检查Warning和Error级别日志中的相关模式

## 9. 版本更新记录

### 版本 1.0
- 初始版本，定义了基本的日志级别和记录规范
- 实现了LogManager类的核心功能

### 版本 1.1
- 优化了日志格式，增加了时区信息
- 增加了异步日志写入功能
- 完善了日志滚动和清理机制

### 版本 1.2
- 细化了日志级别使用场景
- 增加了配置选项和最佳实践指南
- 修复了中文显示问题

## 10. 附录

### 10.1 日志管理器类图
```
LogManager
├── Properties
│   ├── MaxFileSizeKB
│   ├── MaxFilesPerDay
│   ├── MinLogLevel
│   ├── FileNameFormat
│   └── LogDirectory
├── Methods
│   ├── Initialize()
│   ├── InitializeAsync()
│   ├── WriteLog(level, message)
│   ├── WriteLogAsync(level, message)
│   ├── WriteStartupShutdownLog(isStartup)
│   ├── CleanupOldLogs(daysToKeep)
│   └── GetLogDirectorySize()
└── Enum
    └── LogLevel (Info, Warning, Error, Fatal)
```